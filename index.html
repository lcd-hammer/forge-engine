<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORGE ENGINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4f46e5">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ForgeEngine">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none; 
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px; height: 24px;
            background: #4F46E5; 
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            margin-top: -9px; 
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px;
            background: #4F46E5; 
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        input[type="range"] { padding: 0; }
        .mode-button-active {
            background-color: #3B82F6 !important; 
            color: white !important;
        }
        .mode-button-inactive {
            background-color: #E5E7EB; 
            color: #374151; 
        }
        .mode-button-inactive:hover {
            background-color: #D1D5DB; 
        }
        .selector-scroll-button { /* Generic class for scroll buttons */
            min-width: 32px; 
            padding: 0.5rem; 
        }
        .selector-display-area { /* Generic class for single item display */
            width: 64px; 
            height: 64px; 
            padding: 4px; 
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #D1D5DB; 
            border-radius: 0.375rem; 
            cursor: pointer;
            overflow: hidden; /* Ensure content fits */
        }
        .selector-display-area:hover {
            background-color: #F3F4F6; 
        }
        .preview-canvas { /* Generic class for preview canvases */
            width: 56px;  
            height: 56px;
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        .character-preview-text { /* For displaying text characters */
            font-size: 2.5rem; /* Adjust as needed for visibility */
            font-family: monospace; /* Good for fixed-width feel */
            line-height: 1;
        }
        .canvas-container {
            width: 100%; 
        }
    </style>

/* Slider Box Styles */
.slider-container { position: relative; }
#sliderThumbBox {
    position: absolute;
    border: 2px solid #4F46E5;
    box-sizing: content-box;
    border-radius: 0.375rem;
    pointer-events: none;
}

</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4 selection:bg-indigo-500 selection:text-white">

    <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center text-indigo-600 mb-6">FORGE ENGINE</h1>

        <div class="controls mb-4 space-y-2">
            <div class="flex items-center space-x-2 slider-container relative">
                <label for="toolSizeSlider" class="text-sm font-medium text-slate-700 whitespace-nowrap w-28">Tool Size:</label>
                <input type="range" id="toolSizeSlider" min="1" max="25" value="10" step="1" class="flex-grow h-2.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                <span id="toolSizeValue" class="text-sm font-medium text-slate-700 w-10 text-right">10</span>
                <div id="sliderThumbBox" class="pointer-events-none absolute border-2 border-indigo-600 rounded"></div>
            </div>

            <div class="flex items-center space-x-2">
                <label for="dotSpacingSlider" class="text-sm font-medium text-slate-700 whitespace-nowrap w-28">Tool Spacing:</label>
                <input type="range" id="dotSpacingSlider" min="1" max="100" value="10" class="flex-grow h-2.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                <span id="dotSpacingValue" class="text-sm font-medium text-slate-700 w-10 text-right">10</span>
            </div></div>
            
            <div class="my-1">
                <p class="text-xs text-center font-medium text-slate-600 mb-1.5">Place Pattern in Center (Dot Size from Tool Size):</p>
                <div class="flex items-center justify-center space-x-1.5">
                    <button id="prevPatternBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&lt;</button>
                    <div id="patternDisplayArea" class="selector-display-area"> 
                        {/* Single pattern preview canvas will be dynamically added here */}
                    </div>
                    <button id="nextPatternBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&gt;</button>
                </div>
            </div>

            <div class="my-1">
                <p class="text-xs text-center font-medium text-slate-600 mb-1.5">Place Character in Center (Scales with Tool Size):</p>
                <div class="flex items-center justify-center space-x-1.5">
                    <button id="prevCharBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&lt;</button>
                    <div id="charDisplayArea" class="selector-display-area"> 
                        {/* Single character preview will be dynamically added here */}
                    </div>
                    <button id="nextCharBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&gt;</button>
                </div>
            </div>

            <div class="flex space-x-2 mt-2">
                <button id="modeToggleBtn" class="flex-1 mode-button-inactive text-sm font-semibold py-2.5 px-4 rounded-lg shadow-sm">Switch to Eraser</button>
                <button id="clearScreenBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2.5 px-4 rounded-lg shadow-md">Clear Screen</button>
                <button id="exportCsvBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-2.5 px-4 rounded-lg shadow-md">Export Pattern</button>
            </div>
        </div>

        <div class="canvas-container aspect-square rounded-lg overflow-hidden shadow-inner bg-slate-50 border border-slate-300">
            <canvas id="doodleCanvas" class="w-full h-full block"></canvas>
        </div>

         <div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="messageText" class="text-slate-700 mb-4">Message</p>
                <button id="closeMessageBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Get canvas and context
        const canvas = document.getElementById('doodleCanvas');
        const ctx = canvas.getContext('2d');

        // Controls
        const toolSizeSlider = document.getElementById('toolSizeSlider');
        const toolSizeValue = document.getElementById('toolSizeValue');
        const dotSpacingSlider = document.getElementById('dotSpacingSlider');
        const dotSpacingValue = document.getElementById('dotSpacingValue');
        const clearScreenBtn = document.getElementById('clearScreenBtn');
        const modeToggleBtn = document.getElementById('modeToggleBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const toolSizeIndicator = document.getElementById('toolSizeIndicator');
        
        const patternDisplayArea = document.getElementById('patternDisplayArea'); 
        const prevPatternBtn = document.getElementById('prevPatternBtn');
        const nextPatternBtn = document.getElementById('nextPatternBtn');

        const charDisplayArea = document.getElementById('charDisplayArea'); 
        const prevCharBtn = document.getElementById('prevCharBtn'); 
        const nextCharBtn = document.getElementById('nextCharBtn'); 


        // Message Box elements
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');

        // Drawing state
        let drawnDots = []; 
        let dotIdCounter = 0; 

        let isDrawing = false; 
        let currentToolSize = parseInt(toolSizeSlider.value, 10);
        let currentDotSpacing = parseInt(dotSpacingSlider.value, 10);
        let lastActionPointX = 0; 
        let lastActionPointY = 0;
        let defaultDrawColor = '#333333'; 
        let isErasing = false;

        // Font data from C file (arial_normal.c)
        const rawFontData = [
            0x10,0x10,0x20,0x5F, // Header: width, height, startChar, numChars
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // Space
            0x00,0x00,0x00,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,  // !
            0x00,0x00,0x00,0x00,0x02,0x40,0x02,0x40,0x02,0x40,0x02,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // "
            0x00,0x00,0x00,0x00,0x02,0x40,0x02,0x40,0x04,0x80,0x04,0x80,0x3F,0xE0,0x04,0x80,0x09,0x00,0x09,0x00,0x3F,0xE0,0x09,0x00,0x12,0x00,0x12,0x00,0x00,0x00,0x00,0x00,  // #
            0x00,0x00,0x01,0x00,0x03,0xC0,0x05,0x20,0x09,0x20,0x09,0x00,0x09,0x00,0x07,0x00,0x01,0xC0,0x01,0x20,0x01,0x20,0x09,0x20,0x05,0x40,0x03,0x80,0x01,0x00,0x00,0x00,  // $
            0x00,0x00,0x00,0x00,0x1C,0x10,0x22,0x20,0x22,0x20,0x22,0x40,0x22,0x40,0x22,0x9C,0x1C,0xA2,0x01,0x22,0x02,0x22,0x02,0x22,0x04,0x22,0x04,0x1C,0x00,0x00,0x00,0x00,  // %
            0x00,0x00,0x00,0x00,0x01,0xC0,0x02,0x20,0x02,0x20,0x02,0x20,0x01,0x40,0x03,0x80,0x04,0x80,0x08,0x48,0x08,0x50,0x08,0x20,0x04,0x30,0x03,0xC8,0x00,0x00,0x00,0x00,  // &
            0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // '
            0x00,0x00,0x01,0x00,0x02,0x00,0x02,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x02,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,  // (
            0x00,0x00,0x02,0x00,0x01,0x00,0x01,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x01,0x00,0x01,0x00,0x02,0x00,0x00,0x00,0x00,0x00,  // )
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x01,0x80,0x09,0x90,0x1F,0xF8,0x03,0xE0,0x03,0xC0,0x06,0x60,0x06,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // *
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x07,0xF0,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // +
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // ,
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // -
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // .
            0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x80,0x00,0x80,0x00,0x80,0x01,0x00,0x01,0x00,0x01,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x00,  // /
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,  // 0
            0x00,0x00,0x00,0x00,0x00,0x40,0x00,0xC0,0x01,0x40,0x02,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x00,0x00,0x00,  // 1
            0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x40,0x08,0x20,0x00,0x20,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x80,0x01,0x00,0x02,0x00,0x04,0x00,0x0F,0xE0,0x00,0x00,0x00,0x00,  // 2
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x40,0x00,0x40,0x00,0x80,0x03,0x80,0x00,0x40,0x00,0x20,0x00,0x20,0x08,0x20,0x0C,0x40,0x03,0x80,0x00,0x00,0x00,0x00,  // 3
            0x00,0x00,0x00,0x00,0x00,0x40,0x00,0xC0,0x01,0x40,0x01,0x40,0x02,0x40,0x02,0x40,0x04,0x40,0x08,0x40,0x0F,0xF0,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x00,0x00,0x00,  // 4
            0x00,0x00,0x00,0x00,0x01,0xF8,0x01,0x00,0x01,0x00,0x02,0x00,0x03,0xE0,0x02,0x10,0x00,0x08,0x00,0x08,0x00,0x08,0x02,0x08,0x01,0x10,0x00,0xE0,0x00,0x00,0x00,0x00,  // 5
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x60,0x08,0x20,0x08,0x00,0x0B,0x80,0x0C,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,  // 6
            0x00,0x00,0x00,0x00,0x03,0xF8,0x00,0x10,0x00,0x10,0x00,0x20,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // 7
            0x00,0x00,0x00,0x00,0x00,0xE0,0x01,0x10,0x02,0x08,0x02,0x08,0x01,0x10,0x00,0xE0,0x01,0x10,0x02,0x08,0x02,0x08,0x02,0x08,0x01,0x10,0x00,0xE0,0x00,0x00,0x00,0x00,  // 8
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x20,0x08,0x20,0x04,0x40,0x07,0x80,0x00,0x00,0x00,0x00,  // 9
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // :
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // ;
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x60,0x01,0x80,0x06,0x00,0x08,0x00,0x06,0x00,0x01,0x80,0x00,0x60,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // <
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // =
            0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x03,0x00,0x00,0xC0,0x00,0x30,0x00,0x08,0x00,0x30,0x00,0xC0,0x03,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // >
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x00,0x20,0x00,0x40,0x00,0x80,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,  // ?
            0x00,0x00,0x03,0xC0,0x0C,0x30,0x10,0x10,0x13,0x48,0x24,0xC8,0x28,0x88,0x28,0x88,0x28,0x90,0x27,0xE0,0x10,0x08,0x08,0x30,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,  // @
            0x00,0x00,0x00,0x00,0x01,0x00,0x02,0x80,0x02,0x80,0x04,0x40,0x04,0x40,0x04,0x40,0x08,0x20,0x0F,0xE0,0x10,0x10,0x10,0x10,0x20,0x08,0x20,0x08,0x00,0x00,0x00,0x00,  // A
            0x00,0x00,0x00,0x00,0x0F,0xE0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xF0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xE0,0x00,0x00,0x00,0x00,  // B
            0x00,0x00,0x00,0x00,0x03,0xE0,0x04,0x10,0x08,0x08,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x08,0x08,0x04,0x10,0x03,0xE0,0x00,0x00,0x00,0x00,  // C
            0x00,0x00,0x00,0x00,0x1F,0xC0,0x10,0x20,0x10,0x10,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x10,0x10,0x20,0x1F,0xC0,0x00,0x00,0x00,0x00,  // D
            0x00,0x00,0x00,0x00,0x0F,0xF8,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xF0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xF8,0x00,0x00,0x00,0x00,  // E
            0x00,0x00,0x00,0x00,0x0F,0xF0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xE0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x00,0x00,0x00,0x00,  // F
            0x00,0x00,0x00,0x00,0x01,0xE0,0x02,0x10,0x04,0x08,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x7C,0x08,0x04,0x08,0x04,0x04,0x08,0x02,0x10,0x01,0xE0,0x00,0x00,0x00,0x00,  // G
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0F,0xF8,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,  // H
            0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // I
            0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x07,0x80,0x00,0x00,0x00,0x00,  // J
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x10,0x08,0x20,0x08,0x40,0x08,0x80,0x09,0x80,0x0A,0x40,0x0C,0x20,0x08,0x20,0x08,0x10,0x08,0x10,0x08,0x08,0x00,0x00,0x00,0x00,  // K
            0x00,0x00,0x00,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xE0,0x00,0x00,0x00,0x00,  // L
            0x00,0x00,0x00,0x00,0x20,0x08,0x30,0x18,0x30,0x18,0x28,0x28,0x28,0x28,0x24,0x48,0x24,0x48,0x24,0x88,0x22,0x88,0x22,0x88,0x21,0x08,0x21,0x08,0x00,0x00,0x00,0x00,  // M
            0x00,0x00,0x00,0x00,0x08,0x08,0x0C,0x08,0x0A,0x08,0x0A,0x08,0x09,0x08,0x08,0x88,0x08,0x88,0x08,0x48,0x08,0x28,0x08,0x28,0x08,0x18,0x08,0x08,0x00,0x00,0x00,0x00,  // N
            0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x08,0x10,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x08,0x10,0x04,0x20,0x03,0xC0,0x00,0x00,0x00,0x00,  // O
            0x00,0x00,0x00,0x00,0x0F,0xE0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xE0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x00,0x00,0x00,0x00,  // P
            0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x08,0x10,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x08,0xD8,0x04,0x30,0x03,0xD8,0x00,0x00,0x00,0x00,  // Q
            0x00,0x00,0x00,0x00,0x0F,0xE0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xE0,0x08,0x40,0x08,0x20,0x08,0x20,0x08,0x10,0x08,0x08,0x00,0x00,0x00,0x00,  // R
            0x00,0x00,0x00,0x00,0x03,0xE0,0x04,0x10,0x08,0x08,0x08,0x00,0x04,0x00,0x03,0x80,0x00,0x70,0x00,0x08,0x08,0x08,0x08,0x08,0x04,0x10,0x03,0xE0,0x00,0x00,0x00,0x00,  // S
            0x00,0x00,0x00,0x00,0x0F,0xF8,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // T
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x04,0x10,0x03,0xE0,0x00,0x00,0x00,0x00,  // U
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x04,0x10,0x04,0x10,0x04,0x10,0x02,0x20,0x02,0x20,0x02,0x20,0x01,0x40,0x01,0x40,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // V
            0x00,0x00,0x00,0x00,0x20,0x82,0x21,0x82,0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,0x0A,0x28,0x0A,0x28,0x0A,0x28,0x0A,0x28,0x04,0x10,0x04,0x10,0x00,0x00,0x00,0x00,  // W
            0x00,0x00,0x00,0x00,0x10,0x10,0x08,0x20,0x04,0x40,0x04,0x40,0x02,0x80,0x01,0x00,0x02,0x80,0x04,0x40,0x04,0x40,0x08,0x20,0x10,0x10,0x20,0x08,0x00,0x00,0x00,0x00,  // X
            0x00,0x00,0x00,0x00,0x08,0x08,0x04,0x10,0x04,0x10,0x02,0x20,0x01,0x40,0x01,0x40,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // Y
            0x00,0x00,0x00,0x00,0x07,0xF8,0x00,0x10,0x00,0x20,0x00,0x20,0x00,0x40,0x00,0x80,0x00,0x80,0x01,0x00,0x02,0x00,0x02,0x00,0x04,0x00,0x0F,0xF8,0x00,0x00,0x00,0x00,  // Z
            0x00,0x00,0x03,0x80,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x03,0x80,0x00,0x00,  // [
            0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x00,  // <backslash>
            0x00,0x00,0x03,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x03,0x80,0x00,0x00,  // ]
            0x00,0x00,0x01,0x00,0x02,0x80,0x02,0x80,0x04,0x40,0x04,0x40,0x04,0x40,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // ^
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,  // _
            0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // `
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x08,0x20,0x00,0xE0,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x07,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,  // a
            0x00,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0B,0x80,0x0C,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x0C,0x40,0x0B,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // b
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // c
            0x00,0x00,0x00,0x20,0x00,0x20,0x00,0x20,0x03,0xA0,0x04,0x60,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,  // d
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x0F,0xE0,0x08,0x00,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // e
            0x00,0x00,0x00,0xC0,0x01,0x00,0x01,0x00,0x03,0xC0,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // f
            0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xA0,0x04,0x60,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x20,0x08,0x40,0x07,0x80,0x00,0x00,  // g
            0x00,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0B,0xC0,0x0C,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // h
            0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // i
            0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x03,0x00,  // j
            0x00,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x10,0x04,0x20,0x04,0x40,0x04,0x80,0x05,0x80,0x06,0x40,0x04,0x20,0x04,0x20,0x04,0x10,0x00,0x00,0x00,0x00,0x00,0x00,  // k
            0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // l
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2E,0x70,0x31,0x88,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x00,0x00,0x00,0x00,0x00,0x00,  // m
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0xC0,0x0C,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // n
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // o
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0x80,0x0C,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x0C,0x40,0x0B,0x80,0x08,0x00,0x08,0x00,0x08,0x00,  // p
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xA0,0x04,0x60,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x20,0x00,0x20,0x00,0x20,  // q
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xE0,0x03,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // r
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x04,0x00,0x04,0x00,0x03,0xC0,0x00,0x20,0x00,0x20,0x04,0x20,0x03,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,  // s
            0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x03,0xC0,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,  // t
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x07,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,  // u
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x08,0x20,0x04,0x40,0x04,0x40,0x04,0x40,0x02,0x80,0x02,0x80,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // v
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x08,0x21,0x08,0x12,0x90,0x12,0x90,0x14,0x50,0x14,0x50,0x14,0x50,0x08,0x20,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // w
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x04,0x40,0x02,0x80,0x02,0x80,0x01,0x00,0x02,0x80,0x02,0x80,0x04,0x40,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // x
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x04,0x40,0x04,0xC0,0x02,0x80,0x02,0x80,0x01,0x00,0x01,0x00,0x02,0x00,0x0C,0x00,  // y
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xF0,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x80,0x01,0x00,0x01,0x00,0x02,0x00,0x07,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,  // z
            0x00,0xC0,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x06,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0xC0,0x00,0x00,  // {
            0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,  // |
            0x03,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x60,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x03,0x00,0x00,0x00,  // }
            0x00,0x00,0x00,0x00,0x07,0x88,0x08,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00   // ~
        ];

        // Pattern Data (16x16 matrices, from user's new _alpha.txt files)
        const patternTextData = [
            { id: "0", name: "Pattern 0 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001",
                "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "1", name: "Pattern 1 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001",
                "1000000000000001", "1000000000000001", "0100001111000010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "2", name: "Pattern 2 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001",
                "1000000000000001", "1000011111100001", "0100100000010010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "3", name: "Pattern 3 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000101001010001", "1000000000000001",
                "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "4", name: "Pattern 4 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001",
                "1000000000000001", "1000111111110001", "0100100000010010", "0100011111100010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "5", name: "Pattern 5 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000000010", "1000010000110001", "1000000000000001",
                "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "6", name: "Pattern 6 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100000000000010", "1000110000110001", "1000000000000001",
                "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "7", name: "Pattern 7 (Alpha Set 2)", textMatrix: [ 
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100000000000010", "1000110000110001", "1000000000000001",
                "1000000000000001", "1000000000000001", "0100001111000010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "8", name: "Pattern 8 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000010000100001", "1000010000100001",
                "1000000000000001", "1000011111100001", "0100100000010010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "9", name: "Pattern 9 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100010000100010", "1000010000100001", "1000100000010001",
                "1001000000001001", "1000111111110001", "0100100000010010", "0100011111100010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "10", name: "Pattern 10 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000001000100",
                "0100110000110010", "0100000000000010", "1000010000100001", "1000010000100001",
                "1000000000000001", "1000000000000001", "0100001111000010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "11", name: "Pattern 11 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100011111100010", "1000000000000001", "1000000000000001",
                "1000000000000001", "1000010000100001", "0100010000100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "12", name: "Pattern 12 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100011111100010", "1000100000010001", "1000000000000001",
                "1000000000000001", "1000010000100001", "0100010000100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "13", name: "Pattern 13 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100001001000010", "1000110000110001", "1000000000000001",
                "1000101001010001", "1000010000100001", "0100000000000010", "0100001111000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "14", name: "Pattern 14 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100110000110010", "1001001001001001", "1000000000000001",
                "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]},
            { id: "15", name: "Pattern 15 (Alpha Set 3)", textMatrix: [
                "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100",
                "0100000000000010", "0100011001100010", "1000100000010001", "1000000000000001",
                "1000000000000001", "1000011111100001", "0100100000010010", "0100000000000010",
                "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000"
            ]}
        ];

        // Process text matrices into numerical matrices
        const patterns = patternTextData.map(pattern => ({
            ...pattern,
            matrix: pattern.textMatrix.map(rowStr => {
                if (typeof rowStr !== 'string') {
                    console.error(`Invalid row in textMatrix for pattern ${pattern.id}: expected string, got ${typeof rowStr}`, rowStr);
                    return Array(16).fill(0); 
                }
                return rowStr.split('').map(Number);
            })
        }));

        let currentPatternIndex = 0;
        let fontCharacters = []; 
        let currentCharacterIndex = 0; 

        // Function to parse the C font data into 16x16 matrices
        function parseFontData(rawData) {
            const fontWidth = rawData[0];
            const fontHeight = rawData[1];
            const startChar = rawData[2];
            const numChars = rawData[3];
            const charDataOffset = 4;
            const bytesPerChar = fontHeight * (fontWidth / 8); 

            const parsedFont = [];

            for (let i = 0; i < numChars; i++) {
                const charCode = startChar + i;
                const char = String.fromCharCode(charCode);
                const matrix = [];
                const charByteStartIndex = charDataOffset + (i * bytesPerChar);

                for (let y = 0; y < fontHeight; y++) {
                    const row = [];
                    const byte1 = rawData[charByteStartIndex + (y * 2)];
                    const byte2 = rawData[charByteStartIndex + (y * 2) + 1];
                    
                    for (let bit = 7; bit >= 0; bit--) {
                        row.push((byte1 >> bit) & 1);
                    }
                    for (let bit = 7; bit >= 0; bit--) {
                        row.push((byte2 >> bit) & 1);
                    }
                    matrix.push(row);
                }
                parsedFont.push({ char: char, name: `Char '${char}'`, matrix: matrix, id: char });
            }
            return parsedFont;
        }


        // Function to redraw the entire canvas based on the drawnDots array
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = defaultDrawColor; 

            for (const dot of drawnDots) {
                if (dot.isVisible) {
                    ctx.beginPath();
                    ctx.arc(dot.x, dot.y, dot.size / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        // Function to check collision between two circles
        function checkCollision(x1, y1, size1, x2, y2, size2) {
            const dx = x1 - x2;
            const dy = y1 - y2;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < (size1 / 2 + size2 / 2);
        }

        // Function to set canvas dimensions
        function resizeCanvas() {
            const canvasContainer = canvas.parentElement;
            const size = canvasContainer.clientWidth;
            canvas.width = size;
            canvas.height = size; 
            
            ctx.fillStyle = defaultDrawColor;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            redrawCanvas(); 
        }

        // Function to update the visual tool size indicator
        function updateToolSizeIndicator() {
            if (!toolSizeIndicator) return; 
            toolSizeIndicator.style.width = currentToolSize + 'px';
            toolSizeIndicator.style.height = currentToolSize + 'px';
            if (isErasing) {
                toolSizeIndicator.style.backgroundColor = 'rgba(226, 232, 240, 0.7)'; 
                toolSizeIndicator.style.border = '2px dashed #94A3B8'; 
            } else {
                toolSizeIndicator.style.backgroundColor = defaultDrawColor;
                toolSizeIndicator.style.border = 'none'; 
            }
        }

        // Function to draw a 16x16 pattern matrix onto a small preview canvas
        function drawPatternPreview(previewCanvas, matrix) {
            const pCtx = previewCanvas.getContext('2d');
            const previewDotSize = 3.5; 
            previewCanvas.width = 16 * previewDotSize;
            previewCanvas.height = 16 * previewDotSize;
            pCtx.fillStyle = defaultDrawColor;
            pCtx.clearRect(0,0, previewCanvas.width, previewCanvas.height);

            if (!matrix || matrix.length !== 16 ) {
                console.error("Invalid matrix for preview (rows):", matrix);
                return;
            }
            for (let r = 0; r < 16; r++) {
                 if (!matrix[r] || matrix[r].length !== 16) {
                    console.error(`Invalid matrix row ${r} for preview:`, matrix[r]);
                    continue; 
                }
                for (let c = 0; c < 16; c++) {
                    if (matrix[r][c] === 1) {
                        pCtx.fillRect(c * previewDotSize, r * previewDotSize, previewDotSize, previewDotSize);
                    }
                }
            }
        }


        // Function to display the current pattern preview
        function displayCurrentPatternPreview() {
            if (!patternDisplayArea || patterns.length === 0) return;
            patternDisplayArea.innerHTML = ''; 

            const pattern = patterns[currentPatternIndex];
            
            const previewCanvasEl = document.createElement('canvas');
            previewCanvasEl.classList.add('pattern-preview-canvas');
            patternDisplayArea.appendChild(previewCanvasEl);
            patternDisplayArea.title = `${pattern.name} (ID: ${pattern.id})`;
            
            setTimeout(() => drawPatternPreview(previewCanvasEl, pattern.matrix), 0);

            prevPatternBtn.disabled = currentPatternIndex === 0;
            nextPatternBtn.disabled = currentPatternIndex >= patterns.length - 1;
            prevPatternBtn.classList.toggle('opacity-50', prevPatternBtn.disabled);
            nextPatternBtn.classList.toggle('opacity-50', nextPatternBtn.disabled);
        }
        
        patternDisplayArea.addEventListener('click', () => {
            if (patterns.length > 0) {
                const currentPattern = patterns[currentPatternIndex];
                placeMatrixInCenter(currentPattern.matrix, currentPattern.name, currentPattern.id);
            }
        });


        prevPatternBtn.addEventListener('click', () => {
            if (currentPatternIndex > 0) {
                currentPatternIndex--;
                displayCurrentPatternPreview();
            }
        });

        nextPatternBtn.addEventListener('click', () => {
            if (currentPatternIndex < patterns.length - 1) {
                 currentPatternIndex++;
                 displayCurrentPatternPreview();
            }
        });

        // New: Function to display the current character preview
        function displayCurrentCharPreview() {
            if (!charDisplayArea || fontCharacters.length === 0) return;
            charDisplayArea.innerHTML = ''; // Clear previous

            const fontChar = fontCharacters[currentCharacterIndex];
            
            const charTextEl = document.createElement('span');
            charTextEl.classList.add('character-preview-text');
            charTextEl.textContent = fontChar.char === ' ' ? '\u00A0\u00A0' : fontChar.char; 
            charDisplayArea.appendChild(charTextEl);
            charDisplayArea.title = `Character: '${fontChar.char}' (ASCII: ${fontChar.char.charCodeAt(0)})`;
            
            prevCharBtn.disabled = currentCharacterIndex === 0;
            nextCharBtn.disabled = currentCharacterIndex >= fontCharacters.length - 1;
            prevCharBtn.classList.toggle('opacity-50', prevCharBtn.disabled);
            nextCharBtn.classList.toggle('opacity-50', nextCharBtn.disabled);
        }

        // New: Click listener for the character display area
        charDisplayArea.addEventListener('click', () => {
            if (fontCharacters.length > 0) {
                const currentFontChar = fontCharacters[currentCharacterIndex];
                placeMatrixInCenter(currentFontChar.matrix, `Char '${currentFontChar.char}'`, currentFontChar.char);
            }
        });

        // New: Event listeners for character scroll buttons
        prevCharBtn.addEventListener('click', () => {
            if (currentCharacterIndex > 0) {
                currentCharacterIndex--;
                displayCurrentCharPreview();
            }
        });

        nextCharBtn.addEventListener('click', () => {
            if (currentCharacterIndex < fontCharacters.length - 1) {
                 currentCharacterIndex++;
                 displayCurrentCharPreview();
            }
        });


        // Generic function to place a matrix (pattern or character) in the center
        function placeMatrixInCenter(matrix, name, id) {
            if (!matrix || !matrix[0] || matrix.length !== 16 || matrix[0].length !== 16) {
                console.error("Matrix is invalid for", name);
                showMessage(`Error: Could not load ${name}. Invalid pattern.`);
                return;
            }

            const dotSize = currentToolSize; 
            const cellSize = currentToolSize; 

            const gridWidth = 16 * cellSize;
            const gridHeight = 16 * cellSize;

            const startX = (canvas.width / 2) - (gridWidth / 2);
            const startY = (canvas.height / 2) - (gridHeight / 2);

            for (let r = 0; r < 16; r++) {
                if (!matrix[r] || matrix[r].length !== 16) { 
                    console.error(`Invalid row ${r} in matrix for ${name}`);
                    continue; 
                }
                for (let c = 0; c < 16; c++) {
                    if (matrix[r][c] === 1) {
                        const dotX = startX + (c * cellSize) + (cellSize / 2);
                        const dotY = startY + (r * cellSize) + (cellSize / 2);
                        drawnDots.push({
                            id: dotIdCounter++,
                            x: dotX,
                            y: dotY,
                            size: dotSize, 
                            isVisible: true
                        });
                    }
                }
            }
            redrawCanvas();
            showMessage(`${name} (ID: ${id}) placed in center!`);
        }


        // Event Listeners for Drawing Actions
        function startDrawingAction(e) {
            isDrawing = true; 
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            lastActionPointX = x;
            lastActionPointY = y;

            if (isErasing) {
                let erasedSomething = false;
                for (const dot of drawnDots) {
                    if (dot.isVisible && checkCollision(x, y, currentToolSize, dot.x, dot.y, dot.size)) {
                        dot.isVisible = false;
                        erasedSomething = true;
                    }
                }
                if (erasedSomething) redrawCanvas();
            } else { // Pen mode
                drawnDots.push({
                    id: dotIdCounter++,
                    x: x,
                    y: y,
                    size: currentToolSize, 
                    isVisible: true
                });
                redrawCanvas();
            }
        }

        function performDrawingAction(e) {
            if (!isDrawing) return; 

            const rect = canvas.getBoundingClientRect();
            const currentX = (e.clientX || e.touches[0].clientX) - rect.left;
            const currentY = (e.clientY || e.touches[0].clientY) - rect.top;
            
            const dX = currentX - lastActionPointX;
            const dY = currentY - lastActionPointY;
            const distToCurrentMouse = Math.sqrt(dX * dX + dY * dY);
            const angle = Math.atan2(dY, dX);
            
            const spacing = Math.max(1, currentDotSpacing); 
            let numSteps = Math.floor(distToCurrentMouse / spacing);
            let needsRedraw = false;

            for (let i = 1; i <= numSteps; i++) {
                const actionX = lastActionPointX + Math.cos(angle) * spacing * i;
                const actionY = lastActionPointY + Math.sin(angle) * spacing * i;

                if (isErasing) {
                    for (const dot of drawnDots) {
                        if (dot.isVisible && checkCollision(actionX, actionY, currentToolSize, dot.x, dot.y, dot.size)) {
                            dot.isVisible = false;
                            needsRedraw = true;
                        }
                    }
                } else { // Pen mode
                    drawnDots.push({ 
                        id: dotIdCounter++, 
                        x: actionX, 
                        y: actionY, 
                        size: currentToolSize, 
                        isVisible: true 
                    });
                    needsRedraw = true;
                }
            }

            if (numSteps > 0) {
                lastActionPointX = lastActionPointX + Math.cos(angle) * spacing * numSteps;
                lastActionPointY = lastActionPointY + Math.sin(angle) * spacing * numSteps;
            }
            
            if (needsRedraw) {
                redrawCanvas();
            }
        }

        function stopDrawingAction() {
            if (isDrawing) {
                isDrawing = false;
            }
        }

        // Event Listeners for Controls
        toolSizeSlider.addEventListener('input', (e) => {
            currentToolSize = parseInt(e.target.value, 10);
            toolSizeValue.textContent = currentToolSize;
            updateToolSizeIndicator(); 
        });

        dotSpacingSlider.addEventListener('input', (e) => {
            currentDotSpacing = parseInt(e.target.value, 10);
            dotSpacingValue.textContent = currentDotSpacing;
        });
        
        function updateModeButtonAppearance() {
            const toolSizeLabel = document.querySelector('label[for="toolSizeSlider"]');
            if (isErasing) {
                modeToggleBtn.textContent = 'Switch to Pen';
                modeToggleBtn.classList.remove('mode-button-inactive');
                modeToggleBtn.classList.add('mode-button-active');
                toolSizeLabel.textContent = 'Eraser Size:';
                canvas.style.cursor = 'grab'; 
            } else {
                modeToggleBtn.textContent = 'Switch to Eraser';
                modeToggleBtn.classList.remove('mode-button-active');
                modeToggleBtn.classList.add('mode-button-inactive');
                toolSizeLabel.textContent = 'Tool Size:';
                canvas.style.cursor = 'crosshair';
            }
            updateToolSizeIndicator(); 
        }
        
        modeToggleBtn.addEventListener('click', () => {
            isErasing = !isErasing;
            updateModeButtonAppearance();
        });

        clearScreenBtn.addEventListener('click', () => {
            drawnDots = []; 
            dotIdCounter = 0; 
            redrawCanvas(); 
            showMessage("Doodle area cleared!");
        });

        exportCsvBtn.addEventListener('click', () => {
            if (drawnDots.filter(dot => dot.isVisible).length === 0) {
                showMessage("No pattern to export!");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "X,Y,Size\r\n"; 
            drawnDots.forEach(dot => {
                if (dot.isVisible) {
                    csvContent += `${dot.x.toFixed(2)},${dot.y.toFixed(2)},${dot.size}\r\n`;
                }
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "forge_pattern.csv"); 
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
            showMessage("Pattern exported to forge_pattern.csv"); 
        });

        function showMessage(msg) {
            messageText.textContent = msg;
            messageBox.classList.remove('hidden');
        }

        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Mouse/Touch events
        canvas.addEventListener('mousedown', startDrawingAction);
        canvas.addEventListener('mousemove', performDrawingAction);
        canvas.addEventListener('mouseup', stopDrawingAction);
        canvas.addEventListener('mouseout', stopDrawingAction); 
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawingAction(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); performDrawingAction(e); });
        canvas.addEventListener('touchend', stopDrawingAction);
        canvas.addEventListener('touchcancel', stopDrawingAction);

        // Initial setup
        window.addEventListener('load', () => {
            resizeCanvas(); 
            currentToolSize = parseInt(toolSizeSlider.value, 10);
            toolSizeValue.textContent = currentToolSize; 
            updateToolSizeIndicator(); 

            currentDotSpacing = parseInt(dotSpacingSlider.value, 10);
            dotSpacingValue.textContent = currentDotSpacing;
            
            fontCharacters = parseFontData(rawFontData); 
            displayCurrentPatternPreview(); 
            displayCurrentCharPreview(); 
            updateModeButtonAppearance(); 
            canvas.style.cursor = 'crosshair'; 
        });

        window.addEventListener('resize', resizeCanvas);

        // Script to register the Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js') 
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>

<script>
(function(){
    const slider = document.getElementById('toolSizeSlider');
    const valueDisplay = document.getElementById('toolSizeValue');
    const box = document.getElementById('sliderThumbBox');
    const min = parseFloat(slider.min);
    const max = parseFloat(slider.max);
    const maxThumbSize = max * 2; // px per unit
    const boxSize = maxThumbSize + 4; // add 2px border each side
    box.style.width = box.style.height = boxSize + 'px';
    function updateBox(){
        const val = parseFloat(slider.value);
        valueDisplay.textContent = val;
        const percent = (val - min) / (max - min);
        const sliderRect = slider.getBoundingClientRect();
        const containerRect = slider.parentElement.getBoundingClientRect();
        const thumbSize = val * 2;
        const left = percent * (sliderRect.width - thumbSize) + sliderRect.left - containerRect.left - 2;
        const top = sliderRect.top - containerRect.top - (boxSize - sliderRect.height) / 2;
        box.style.transform = `translate(${left}px, ${top}px)`;
    }
    slider.addEventListener('input', updateBox);
    window.addEventListener('resize', updateBox);
    updateBox();
})();
</script>

</body>
</html>
