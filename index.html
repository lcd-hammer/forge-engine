<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORGE ENGINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4f46e5">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ForgeEngine">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
        .mode-button-active {
            background-color: #3B82F6 !important;
            color: white !important;
        }
        .mode-button-inactive {
            background-color: #E5E7EB;
            color: #374151;
        }
        .mode-button-inactive:hover {
            background-color: #D1D5DB;
        }
        .selector-scroll-button {
            min-width: 32px;
            padding: 0.5rem;
        }
        .selector-display-area {
            width: 64px;
            height: 64px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            cursor: pointer;
            overflow: hidden;
        }
        .selector-display-area:hover {
            background-color: #F3F4F6;
        }
        .preview-canvas {
            width: 56px;
            height: 56px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        .character-preview-text {
            font-size: 2.5rem;
            font-family: monospace;
            line-height: 1;
        }
        .canvas-container {
            width: 100%;
        }

        /* --- Custom Slider Styles --- */
        .slider-widget {
            flex-grow: 1;
            margin: 0 10px;
        }
        .slider-track {
            width: 100%;
            height: 44px;
            background-color: #e9e9e9;
            border-radius: 6px;
            position: relative;
            cursor: pointer;
        }
        .slider-box {
            width: 44px;
            height: 44px;
            background-color: #a0c4ff;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            position: absolute;
            top: 0;
            left: 0;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }
        .slider-dot {
            background-color: #333333;
            border-radius: 50%;
            transition: width 0.05s ease-out, height 0.05s ease-out;
        }

    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4 selection:bg-indigo-500 selection:text-white">

    <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center text-indigo-600 mb-6">FORGE ENGINE</h1>

        <div class="controls mb-6 space-y-4">
            <div class="flex items-center space-x-2">
                <label id="toolSizeLabel" class="text-sm font-medium text-slate-700 whitespace-nowrap w-28">Tool Size:</label>
                <div class="slider-widget">
                    <div class="slider-track" id="toolSizeSliderTrack">
                        <div class="slider-box" id="toolSizeSliderBox">
                            <div class="slider-dot" id="toolSizeSliderDot" style="width: 2px; height: 2px;"></div>
                        </div>
                    </div>
                </div>
                <span id="toolSizeValue" class="text-sm font-medium text-slate-700 w-10 text-right">1</span>
            </div>

            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-slate-700 whitespace-nowrap w-28">Tool Spacing:</label>
                 <div class="slider-widget">
                    <div class="slider-track" id="dotSpacingSliderTrack">
                        <div class="slider-box" id="dotSpacingSliderBox">
                            <div class="slider-dot" id="dotSpacingSliderDot" style="width: 8px; height: 8px;"></div>
                        </div>
                    </div>
                </div>
                <span id="dotSpacingValue" class="text-sm font-medium text-slate-700 w-10 text-right">10</span>
            </div>

            <div class="my-1 pt-6">
                <p class="text-xs text-center font-medium text-slate-600 mb-1.5">Place Pattern in Center (Dot Size from Tool Size):</p>
                <div class="flex items-center justify-center space-x-1.5">
                    <button id="prevPatternBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&lt;</button>
                    <div id="patternDisplayArea" class="selector-display-area"></div>
                    <button id="nextPatternBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&gt;</button>
                </div>
            </div>

            <div class="my-1">
                <p class="text-xs text-center font-medium text-slate-600 mb-1.5">Place Character in Center (Scales with Tool Size):</p>
                <div class="flex items-center justify-center space-x-1.5">
                    <button id="prevCharBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&lt;</button>
                    <div id="charDisplayArea" class="selector-display-area"></div>
                    <button id="nextCharBtn" class="selector-scroll-button bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md shadow-sm">&gt;</button>
                </div>
            </div>

            <div class="flex space-x-2 mt-2">
                <button id="modeToggleBtn" class="flex-1 mode-button-inactive text-sm font-semibold py-2.5 px-4 rounded-lg shadow-sm">Switch to Eraser</button>
                <button id="clearScreenBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2.5 px-4 rounded-lg shadow-md">Clear Screen</button>
                <button id="exportCsvBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-2.5 px-4 rounded-lg shadow-md">Export Pattern</button>
            </div>
        </div>

        <div class="canvas-container aspect-square rounded-lg overflow-hidden shadow-inner bg-slate-50 border border-slate-300">
            <canvas id="doodleCanvas" class="w-full h-full block"></canvas>
        </div>

         <div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="messageText" class="text-slate-700 mb-4">Message</p>
                <button id="closeMessageBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- App State ---
        let currentToolSize = 1;
        let currentDotSpacing = 10;
        let drawnDots = [];
        let dotIdCounter = 0;
        let isDrawing = false;
        let lastActionPointX = 0;
        let lastActionPointY = 0;
        let isErasing = false;
        let defaultDrawColor = '#333333';
        let currentPatternIndex = 0;
        let fontCharacters = [];
        let currentCharacterIndex = 0;

        // --- Data ---
        const rawFontData = [
            0x10,0x10,0x20,0x5F, // Header: width, height, startChar, numChars
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // Space
            0x00,0x00,0x00,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,  // !
            0x00,0x00,0x00,0x00,0x02,0x40,0x02,0x40,0x02,0x40,0x02,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // "
            0x00,0x00,0x00,0x00,0x02,0x40,0x02,0x40,0x04,0x80,0x04,0x80,0x3F,0xE0,0x04,0x80,0x09,0x00,0x09,0x00,0x3F,0xE0,0x09,0x00,0x12,0x00,0x12,0x00,0x00,0x00,0x00,0x00,  // #
            0x00,0x00,0x01,0x00,0x03,0xC0,0x05,0x20,0x09,0x20,0x09,0x00,0x09,0x00,0x07,0x00,0x01,0xC0,0x01,0x20,0x01,0x20,0x09,0x20,0x05,0x40,0x03,0x80,0x01,0x00,0x00,0x00,  // $
            0x00,0x00,0x00,0x00,0x1C,0x10,0x22,0x20,0x22,0x20,0x22,0x40,0x22,0x40,0x22,0x9C,0x1C,0xA2,0x01,0x22,0x02,0x22,0x02,0x22,0x04,0x22,0x04,0x1C,0x00,0x00,0x00,0x00,  // %
            0x00,0x00,0x00,0x00,0x01,0xC0,0x02,0x20,0x02,0x20,0x02,0x20,0x01,0x40,0x03,0x80,0x04,0x80,0x08,0x48,0x08,0x50,0x08,0x20,0x04,0x30,0x03,0xC8,0x00,0x00,0x00,0x00,  // &
            0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // '
            0x00,0x00,0x01,0x00,0x02,0x00,0x02,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x02,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,  // (
            0x00,0x00,0x02,0x00,0x01,0x00,0x01,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x01,0x00,0x01,0x00,0x02,0x00,0x00,0x00,0x00,0x00,  // )
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x01,0x80,0x09,0x90,0x1F,0xF8,0x03,0xE0,0x03,0xC0,0x06,0x60,0x06,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // *
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x07,0xF0,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // +
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // ,
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // -
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // .
            0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x80,0x00,0x80,0x00,0x80,0x01,0x00,0x01,0x00,0x01,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x00,  // /
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,  // 0
            0x00,0x00,0x00,0x00,0x00,0x40,0x00,0xC0,0x01,0x40,0x02,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x00,0x00,0x00,  // 1
            0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x40,0x08,0x20,0x00,0x20,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x80,0x01,0x00,0x02,0x00,0x04,0x00,0x0F,0xE0,0x00,0x00,0x00,0x00,  // 2
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x40,0x00,0x40,0x00,0x80,0x03,0x80,0x00,0x40,0x00,0x20,0x00,0x20,0x08,0x20,0x0C,0x40,0x03,0x80,0x00,0x00,0x00,0x00,  // 3
            0x00,0x00,0x00,0x00,0x00,0x40,0x00,0xC0,0x01,0x40,0x01,0x40,0x02,0x40,0x02,0x40,0x04,0x40,0x08,0x40,0x0F,0xF0,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x00,0x00,0x00,  // 4
            0x00,0x00,0x00,0x00,0x01,0xF8,0x01,0x00,0x01,0x00,0x02,0x00,0x03,0xE0,0x02,0x10,0x00,0x08,0x00,0x08,0x00,0x08,0x02,0x08,0x01,0x10,0x00,0xE0,0x00,0x00,0x00,0x00,  // 5
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x60,0x08,0x20,0x08,0x00,0x0B,0x80,0x0C,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,  // 6
            0x00,0x00,0x00,0x00,0x03,0xF8,0x00,0x10,0x00,0x10,0x00,0x20,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // 7
            0x00,0x00,0x00,0x00,0x00,0xE0,0x01,0x10,0x02,0x08,0x02,0x08,0x01,0x10,0x00,0xE0,0x01,0x10,0x02,0x08,0x02,0x08,0x02,0x08,0x01,0x10,0x00,0xE0,0x00,0x00,0x00,0x00,  // 8
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x20,0x08,0x20,0x04,0x40,0x07,0x80,0x00,0x00,0x00,0x00,  // 9
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // :
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // ;
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x60,0x01,0x80,0x06,0x00,0x08,0x00,0x06,0x00,0x01,0x80,0x00,0x60,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // <
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // =
            0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x03,0x00,0x00,0xC0,0x00,0x30,0x00,0x08,0x00,0x30,0x00,0xC0,0x03,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // >
            0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x00,0x20,0x00,0x40,0x00,0x80,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,  // ?
            0x00,0x00,0x03,0xC0,0x0C,0x30,0x10,0x10,0x13,0x48,0x24,0xC8,0x28,0x88,0x28,0x88,0x28,0x90,0x27,0xE0,0x10,0x08,0x08,0x30,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,  // @
            0x00,0x00,0x00,0x00,0x01,0x00,0x02,0x80,0x02,0x80,0x04,0x40,0x04,0x40,0x04,0x40,0x08,0x20,0x0F,0xE0,0x10,0x10,0x10,0x10,0x20,0x08,0x20,0x08,0x00,0x00,0x00,0x00,  // A
            0x00,0x00,0x00,0x00,0x0F,0xE0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xF0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xE0,0x00,0x00,0x00,0x00,  // B
            0x00,0x00,0x00,0x00,0x03,0xE0,0x04,0x10,0x08,0x08,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x08,0x08,0x04,0x10,0x03,0xE0,0x00,0x00,0x00,0x00,  // C
            0x00,0x00,0x00,0x00,0x1F,0xC0,0x10,0x20,0x10,0x10,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x10,0x10,0x20,0x1F,0xC0,0x00,0x00,0x00,0x00,  // D
            0x00,0x00,0x00,0x00,0x0F,0xF8,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xF0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xF8,0x00,0x00,0x00,0x00,  // E
            0x00,0x00,0x00,0x00,0x0F,0xF0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xE0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x00,0x00,0x00,0x00,  // F
            0x00,0x00,0x00,0x00,0x01,0xE0,0x02,0x10,0x04,0x08,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x7C,0x08,0x04,0x08,0x04,0x04,0x08,0x02,0x10,0x01,0xE0,0x00,0x00,0x00,0x00,  // G
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0F,0xF8,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,  // H
            0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // I
            0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x07,0x80,0x00,0x00,0x00,0x00,  // J
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x10,0x08,0x20,0x08,0x40,0x08,0x80,0x09,0x80,0x0A,0x40,0x0C,0x20,0x08,0x20,0x08,0x10,0x08,0x10,0x08,0x08,0x00,0x00,0x00,0x00,  // K
            0x00,0x00,0x00,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0F,0xE0,0x00,0x00,0x00,0x00,  // L
            0x00,0x00,0x00,0x00,0x20,0x08,0x30,0x18,0x30,0x18,0x28,0x28,0x28,0x28,0x24,0x48,0x24,0x48,0x24,0x88,0x22,0x88,0x22,0x88,0x21,0x08,0x21,0x08,0x00,0x00,0x00,0x00,  // M
            0x00,0x00,0x00,0x00,0x08,0x08,0x0C,0x08,0x0A,0x08,0x0A,0x08,0x09,0x08,0x08,0x88,0x08,0x88,0x08,0x48,0x08,0x28,0x08,0x28,0x08,0x18,0x08,0x08,0x00,0x00,0x00,0x00,  // N
            0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x08,0x10,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x08,0x10,0x04,0x20,0x03,0xC0,0x00,0x00,0x00,0x00,  // O
            0x00,0x00,0x00,0x00,0x0F,0xE0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xE0,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x00,0x00,0x00,0x00,  // P
            0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x08,0x10,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0x08,0xD8,0x04,0x30,0x03,0xD8,0x00,0x00,0x00,0x00,  // Q
            0x00,0x00,0x00,0x00,0x0F,0xE0,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x0F,0xE0,0x08,0x40,0x08,0x20,0x08,0x20,0x08,0x10,0x08,0x08,0x00,0x00,0x00,0x00,  // R
            0x00,0x00,0x00,0x00,0x03,0xE0,0x04,0x10,0x08,0x08,0x08,0x00,0x04,0x00,0x03,0x80,0x00,0x70,0x00,0x08,0x08,0x08,0x08,0x08,0x04,0x10,0x03,0xE0,0x00,0x00,0x00,0x00,  // S
            0x00,0x00,0x00,0x00,0x0F,0xF8,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // T
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x04,0x10,0x03,0xE0,0x00,0x00,0x00,0x00,  // U
            0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x04,0x10,0x04,0x10,0x04,0x10,0x02,0x20,0x02,0x20,0x02,0x20,0x01,0x40,0x01,0x40,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // V
            0x00,0x00,0x00,0x00,0x20,0x82,0x21,0x82,0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,0x0A,0x28,0x0A,0x28,0x0A,0x28,0x0A,0x28,0x04,0x10,0x04,0x10,0x00,0x00,0x00,0x00,  // W
            0x00,0x00,0x00,0x00,0x10,0x10,0x08,0x20,0x04,0x40,0x04,0x40,0x02,0x80,0x01,0x00,0x02,0x80,0x04,0x40,0x04,0x40,0x08,0x20,0x10,0x10,0x20,0x08,0x00,0x00,0x00,0x00,  // X
            0x00,0x00,0x00,0x00,0x08,0x08,0x04,0x10,0x04,0x10,0x02,0x20,0x01,0x40,0x01,0x40,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,  // Y
            0x00,0x00,0x00,0x00,0x07,0xF8,0x00,0x10,0x00,0x20,0x00,0x20,0x00,0x40,0x00,0x80,0x00,0x80,0x01,0x00,0x02,0x00,0x02,0x00,0x04,0x00,0x0F,0xF8,0x00,0x00,0x00,0x00,  // Z
            0x00,0x00,0x03,0x80,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x03,0x80,0x00,0x00,  // [
            0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x00,  // <backslash>
            0x00,0x00,0x03,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x03,0x80,0x00,0x00,  // ]
            0x00,0x00,0x01,0x00,0x02,0x80,0x02,0x80,0x04,0x40,0x04,0x40,0x04,0x40,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // ^
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,  // _
            0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // `
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x08,0x20,0x00,0xE0,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x07,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,  // a
            0x00,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0B,0x80,0x0C,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x0C,0x40,0x0B,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // b
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // c
            0x00,0x00,0x00,0x20,0x00,0x20,0x00,0x20,0x03,0xA0,0x04,0x60,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,  // d
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x0F,0xE0,0x08,0x00,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // e
            0x00,0x00,0x00,0xC0,0x01,0x00,0x01,0x00,0x03,0xC0,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // f
            0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xA0,0x04,0x60,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x20,0x08,0x40,0x07,0x80,0x00,0x00,  // g
            0x00,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x0B,0xC0,0x0C,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // h
            0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // i
            0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x03,0x00,  // j
            0x00,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x10,0x04,0x20,0x04,0x40,0x04,0x80,0x05,0x80,0x06,0x40,0x04,0x20,0x04,0x20,0x04,0x10,0x00,0x00,0x00,0x00,0x00,0x00,  // k
            0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // l
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2E,0x70,0x31,0x88,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x21,0x08,0x00,0x00,0x00,0x00,0x00,0x00,  // m
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0xC0,0x0C,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // n
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x04,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,  // o
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0x80,0x0C,0x40,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x0C,0x40,0x0B,0x80,0x08,0x00,0x08,0x00,0x08,0x00,  // p
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xA0,0x04,0x60,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x60,0x03,0xA0,0x00,0x20,0x00,0x20,0x00,0x20,  // q
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xE0,0x03,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // r
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x04,0x20,0x04,0x00,0x04,0x00,0x03,0xC0,0x00,0x20,0x00,0x20,0x04,0x20,0x03,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,  // s
            0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x03,0xC0,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,  // t
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x07,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,  // u
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x08,0x20,0x04,0x40,0x04,0x40,0x04,0x40,0x02,0x80,0x02,0x80,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // v
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x08,0x21,0x08,0x12,0x90,0x12,0x90,0x14,0x50,0x14,0x50,0x14,0x50,0x08,0x20,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // w
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x04,0x40,0x02,0x80,0x02,0x80,0x01,0x00,0x02,0x80,0x02,0x80,0x04,0x40,0x08,0x20,0x00,0x00,0x00,0x00,0x00,0x00,  // x
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x20,0x08,0x20,0x08,0x20,0x04,0x40,0x04,0x40,0x04,0xC0,0x02,0x80,0x02,0x80,0x01,0x00,0x01,0x00,0x02,0x00,0x0C,0x00,  // y
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xF0,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x80,0x01,0x00,0x01,0x00,0x02,0x00,0x07,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,  // z
            0x00,0xC0,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x06,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x00,0xC0,0x00,0x00,  // {
            0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,  // |
            0x03,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x60,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x03,0x00,0x00,0x00,  // }
            0x00,0x00,0x00,0x00,0x07,0x88,0x08,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00   // ~
        ];
        const patternTextData = [
            { id: "0", name: "Pattern 0 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001", "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "1", name: "Pattern 1 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001", "1000000000000001", "1000000000000001", "0100001111000010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "2", name: "Pattern 2 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001", "1000000000000001", "1000011111100001", "0100100000010010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "3", name: "Pattern 3 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000101001010001", "1000000000000001", "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "4", name: "Pattern 4 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000010000100001", "1000000000000001", "1000000000000001", "1000111111110001", "0100100000010010", "0100011111100010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "5", name: "Pattern 5 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000000010", "1000010000110001", "1000000000000001", "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "6", name: "Pattern 6 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100000000000010", "1000110000110001", "1000000000000001", "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "7", name: "Pattern 7 (Alpha Set 2)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100000000000010", "1000110000110001", "1000000000000001", "1000000000000001", "1000000000000001", "0100001111000010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "8", name: "Pattern 8 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000010000100001", "1000010000100001", "1000000000000001", "1000011111100001", "0100100000010010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "9", name: "Pattern 9 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100010000100010", "1000010000100001", "1000100000010001", "1001000000001001", "1000111111110001", "0100100000010010", "0100011111100010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "10", name: "Pattern 10 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000001000100", "0100110000110010", "0100000000000010", "1000010000100001", "1000010000100001", "1000000000000001", "1000000000000001", "0100001111000010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "11", name: "Pattern 11 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100011111100010", "1000000000000001", "1000000000000001", "1000000000000001", "1000010000100001", "0100010000100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "12", name: "Pattern 12 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100011111100010", "1000100000010001", "1000000000000001", "1000000000000001", "1000010000100001", "0100010000100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "13", name: "Pattern 13 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100001001000010", "1000110000110001", "1000000000000001", "1000101001010001", "1000010000100001", "0100000000000010", "0100001111000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "14", name: "Pattern 14 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100110000110010", "1001001001001001", "1000000000000001", "1000000000000001", "1000100000010001", "0100011111100010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]},
            { id: "15", name: "Pattern 15 (Alpha Set 3)", textMatrix: [ "0000001111000000", "0000110000110000", "0001000000001000", "0010000000000100", "0100000000000010", "0100011001100010", "1000100000010001", "1000000000000001", "1000000000000001", "1000011111100001", "0100100000010010", "0100000000000010", "0010000000000100", "0001000000001000", "0000110000110000", "0000001111000000" ]}
        ];

        const patterns = patternTextData.map(pattern => ({
            ...pattern,
            matrix: pattern.textMatrix.map(rowStr => rowStr.split('').map(Number))
        }));

        // --- Core Functions & Logic ---
        function parseFontData(rawData) {
            const fontWidth = rawData[0];
            const fontHeight = rawData[1];
            const startChar = rawData[2];
            const numChars = rawData[3];
            const charDataOffset = 4;
            const bytesPerChar = fontHeight * (fontWidth / 8);
            const parsedFont = [];

            for (let i = 0; i < numChars; i++) {
                const charCode = startChar + i;
                const char = String.fromCharCode(charCode);
                const matrix = [];
                const charByteStartIndex = charDataOffset + (i * bytesPerChar);

                for (let y = 0; y < fontHeight; y++) {
                    const row = [];
                    const byte1 = rawData[charByteStartIndex + (y * 2)];
                    const byte2 = rawData[charByteStartIndex + (y * 2) + 1];

                    for (let bit = 7; bit >= 0; bit--) {
                        row.push((byte1 >> bit) & 1);
                    }
                    for (let bit = 7; bit >= 0; bit--) {
                        row.push((byte2 >> bit) & 1);
                    }
                    matrix.push(row);
                }
                parsedFont.push({ char: char, name: `Char '${char}'`, matrix: matrix, id: char });
            }
            return parsedFont;
        }

        function redrawCanvas() {
            const canvas = document.getElementById('doodleCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = defaultDrawColor;
            for (const dot of drawnDots) {
                if (dot.isVisible) {
                    ctx.beginPath();
                    ctx.arc(dot.x, dot.y, dot.size / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function checkCollision(x1, y1, size1, x2, y2, size2) {
            const dx = x1 - x2;
            const dy = y1 - y2;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < (size1 / 2 + size2 / 2);
        }

        function resizeCanvas() {
            const canvas = document.getElementById('doodleCanvas');
            const canvasContainer = canvas.parentElement;
            const size = canvasContainer.clientWidth;
            canvas.width = size;
            canvas.height = size;

            const ctx = canvas.getContext('2d');
            ctx.fillStyle = defaultDrawColor;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            redrawCanvas();
        }

        function drawPatternPreview(previewCanvas, matrix) {
            const pCtx = previewCanvas.getContext('2d');
            const previewDotSize = 3.5;
            previewCanvas.width = 16 * previewDotSize;
            previewCanvas.height = 16 * previewDotSize;
            pCtx.fillStyle = defaultDrawColor;
            pCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            if (!matrix || matrix.length !== 16) return;
            for (let r = 0; r < 16; r++) {
                if (!matrix[r] || matrix[r].length !== 16) continue;
                for (let c = 0; c < 16; c++) {
                    if (matrix[r][c] === 1) {
                        pCtx.fillRect(c * previewDotSize, r * previewDotSize, previewDotSize, previewDotSize);
                    }
                }
            }
        }

        function displayCurrentPatternPreview() {
            const patternDisplayArea = document.getElementById('patternDisplayArea');
            if (!patternDisplayArea || patterns.length === 0) return;
            patternDisplayArea.innerHTML = '';
            const pattern = patterns[currentPatternIndex];
            const previewCanvasEl = document.createElement('canvas');
            previewCanvasEl.classList.add('pattern-preview-canvas');
            patternDisplayArea.appendChild(previewCanvasEl);
            patternDisplayArea.title = `${pattern.name} (ID: ${pattern.id})`;
            setTimeout(() => drawPatternPreview(previewCanvasEl, pattern.matrix), 0);
            document.getElementById('prevPatternBtn').disabled = currentPatternIndex === 0;
            document.getElementById('nextPatternBtn').disabled = currentPatternIndex >= patterns.length - 1;
            document.getElementById('prevPatternBtn').classList.toggle('opacity-50', currentPatternIndex === 0);
            document.getElementById('nextPatternBtn').classList.toggle('opacity-50', currentPatternIndex >= patterns.length - 1);
        }

        function displayCurrentCharPreview() {
            const charDisplayArea = document.getElementById('charDisplayArea');
            if (!charDisplayArea || fontCharacters.length === 0) return;
            charDisplayArea.innerHTML = '';
            const fontChar = fontCharacters[currentCharacterIndex];
            const charTextEl = document.createElement('span');
            charTextEl.classList.add('character-preview-text');
            charTextEl.textContent = fontChar.char === ' ' ? '\u00A0\u00A0' : fontChar.char;
            charDisplayArea.appendChild(charTextEl);
            charDisplayArea.title = `Character: '${fontChar.char}' (ASCII: ${fontChar.char.charCodeAt(0)})`;
            document.getElementById('prevCharBtn').disabled = currentCharacterIndex === 0;
            document.getElementById('nextCharBtn').disabled = currentCharacterIndex >= fontCharacters.length - 1;
            document.getElementById('prevCharBtn').classList.toggle('opacity-50', currentCharacterIndex === 0);
            document.getElementById('nextCharBtn').classList.toggle('opacity-50', currentCharacterIndex >= fontCharacters.length - 1);
        }

        function placeMatrixInCenter(matrix, name, id) {
            const canvas = document.getElementById('doodleCanvas');
            if (!matrix || !matrix[0] || matrix.length !== 16 || matrix[0].length !== 16) {
                showMessage(`Error: Could not load ${name}. Invalid pattern.`);
                return;
            }
            const dotSize = currentToolSize;
            const cellSize = currentToolSize;
            const gridWidth = 16 * cellSize;
            const gridHeight = 16 * cellSize;
            const startX = (canvas.width / 2) - (gridWidth / 2);
            const startY = (canvas.height / 2) - (gridHeight / 2);

            for (let r = 0; r < 16; r++) {
                if (!matrix[r] || matrix[r].length !== 16) continue;
                for (let c = 0; c < 16; c++) {
                    if (matrix[r][c] === 1) {
                        const dotX = startX + (c * cellSize) + (cellSize / 2);
                        const dotY = startY + (r * cellSize) + (cellSize / 2);
                        drawnDots.push({ id: dotIdCounter++, x: dotX, y: dotY, size: dotSize, isVisible: true });
                    }
                }
            }
            redrawCanvas();
            showMessage(`${name} (ID: ${id}) placed in center!`);
        }

        function startDrawingAction(e) {
            isDrawing = true;
            const canvas = document.getElementById('doodleCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            lastActionPointX = x;
            lastActionPointY = y;

            if (isErasing) {
                let erasedSomething = false;
                for (const dot of drawnDots) {
                    if (dot.isVisible && checkCollision(x, y, currentToolSize, dot.x, dot.y, dot.size)) {
                        dot.isVisible = false;
                        erasedSomething = true;
                    }
                }
                if (erasedSomething) redrawCanvas();
            } else {
                drawnDots.push({ id: dotIdCounter++, x: x, y: y, size: currentToolSize, isVisible: true });
                redrawCanvas();
            }
        }

        function performDrawingAction(e) {
            if (!isDrawing) return;
            const canvas = document.getElementById('doodleCanvas');
            const rect = canvas.getBoundingClientRect();
            const currentX = (e.clientX || e.touches[0].clientX) - rect.left;
            const currentY = (e.clientY || e.touches[0].clientY) - rect.top;
            const dX = currentX - lastActionPointX;
            const dY = currentY - lastActionPointY;
            const dist = Math.sqrt(dX * dX + dY * dY);
            const angle = Math.atan2(dY, dX);
            const spacing = Math.max(1, currentDotSpacing);
            const numSteps = Math.floor(dist / spacing);
            let needsRedraw = false;

            for (let i = 1; i <= numSteps; i++) {
                const actionX = lastActionPointX + Math.cos(angle) * spacing * i;
                const actionY = lastActionPointY + Math.sin(angle) * spacing * i;
                if (isErasing) {
                    for (const dot of drawnDots) {
                        if (dot.isVisible && checkCollision(actionX, actionY, currentToolSize, dot.x, dot.y, dot.size)) {
                            dot.isVisible = false;
                            needsRedraw = true;
                        }
                    }
                } else {
                    drawnDots.push({ id: dotIdCounter++, x: actionX, y: actionY, size: currentToolSize, isVisible: true });
                    needsRedraw = true;
                }
            }

            if (numSteps > 0) {
                lastActionPointX = lastActionPointX + Math.cos(angle) * numSteps * spacing;
                lastActionPointY = lastActionPointY + Math.sin(angle) * numSteps * spacing;
            }

            if (needsRedraw) redrawCanvas();
        }
        
        function stopDrawingAction() {
            if (isDrawing) {
                isDrawing = false;
            }
        }

        function createCustomSlider(options) {
            const { trackId, boxId, dotId, valueDisplayId, min, max, initialValue, onUpdate, isDotDynamic } = options;
            const sliderTrack = document.getElementById(trackId);
            const sliderBox = document.getElementById(boxId);
            const sliderDot = document.getElementById(dotId);
            const sliderValueDisplay = document.getElementById(valueDisplayId);
            const SLIDER_BOX_SIZE = 44;
            let trackWidth, maxBoxLeftPosition, isDragging = false, dragStartX = 0, initialBoxLeft = 0;

            function updateSliderUI(value) {
                const validatedValue = Math.max(min, Math.min(max, Math.round(value)));
                onUpdate(validatedValue);
                sliderValueDisplay.textContent = validatedValue;
                if (isDotDynamic) {
                    const safeDiameter = Math.min(validatedValue, SLIDER_BOX_SIZE - 4);
                    sliderDot.style.width = `${Math.max(0, safeDiameter)}px`;
                    sliderDot.style.height = `${Math.max(0, safeDiameter)}px`;
                }
                let normalizedValue = (max - min > 0) ? (validatedValue - min) / (max - min) : 0;
                const newBoxLeft = normalizedValue * maxBoxLeftPosition;
                sliderBox.style.left = `${newBoxLeft}px`;
            }

            function getValueFromPosition(boxLeft) {
                if (maxBoxLeftPosition === 0) return min;
                const normalizedPos = Math.max(0, Math.min(1, boxLeft / maxBoxLeftPosition));
                return Math.max(min, Math.min(max, Math.round(min + normalizedPos * (max - min))));
            }

            function handleDragStart(clientX) {
                isDragging = true;
                dragStartX = clientX;
                initialBoxLeft = sliderBox.offsetLeft;
                sliderBox.style.cursor = 'grabbing';
            }

            function handleDragMove(clientX) {
                if (!isDragging) return;
                const deltaX = clientX - dragStartX;
                const newBoxLeft = initialBoxLeft + deltaX;
                const clampedBoxLeft = Math.max(0, Math.min(maxBoxLeftPosition, newBoxLeft));
                sliderBox.style.left = `${clampedBoxLeft}px`;
                const calculatedValue = getValueFromPosition(clampedBoxLeft);
                if (parseInt(sliderValueDisplay.textContent) !== calculatedValue) {
                    updateSliderUI(calculatedValue);
                }
            }

            function handleDragEnd() {
                if (isDragging) {
                    isDragging = false;
                    sliderBox.style.cursor = 'grab';
                    const finalValue = getValueFromPosition(sliderBox.offsetLeft);
                    updateSliderUI(finalValue);
                }
            }

            sliderBox.addEventListener('mousedown', e => { e.preventDefault(); handleDragStart(e.clientX); });
            document.addEventListener('mousemove', e => { if (isDragging) { e.preventDefault(); handleDragMove(e.clientX); } });
            document.addEventListener('mouseup', handleDragEnd);
            sliderBox.addEventListener('touchstart', e => { e.preventDefault(); handleDragStart(e.touches[0].clientX); });
            document.addEventListener('touchmove', e => { if (isDragging) { e.preventDefault(); handleDragMove(e.touches[0].clientX); } }, { passive: false });
            document.addEventListener('touchend', handleDragEnd);
            sliderTrack.addEventListener('click', e => {
                if (e.target === sliderBox || sliderBox.contains(e.target)) return;
                const trackRect = sliderTrack.getBoundingClientRect();
                const clickXInTrack = e.clientX - trackRect.left;
                let targetBoxLeft = clickXInTrack - (SLIDER_BOX_SIZE / 2);
                targetBoxLeft = Math.max(0, Math.min(maxBoxLeftPosition, targetBoxLeft));
                updateSliderUI(getValueFromPosition(targetBoxLeft));
            });
            
            function reinitializeSliderLayout() {
                trackWidth = sliderTrack.offsetWidth;
                maxBoxLeftPosition = trackWidth - SLIDER_BOX_SIZE;
                updateSliderUI(parseInt(sliderValueDisplay.textContent, 10));
            }

            window.addEventListener('resize', reinitializeSliderLayout);
            reinitializeSliderLayout();
        }

        function updateModeButtonAppearance() {
            const toolSizeLabel = document.getElementById('toolSizeLabel');
            const modeToggleBtn = document.getElementById('modeToggleBtn');
            const canvas = document.getElementById('doodleCanvas');
            if (isErasing) {
                modeToggleBtn.textContent = 'Switch to Pen';
                modeToggleBtn.classList.remove('mode-button-inactive');
                modeToggleBtn.classList.add('mode-button-active');
                toolSizeLabel.textContent = 'Eraser Size:';
                canvas.style.cursor = 'grab';
            } else {
                modeToggleBtn.textContent = 'Switch to Eraser';
                modeToggleBtn.classList.remove('mode-button-active');
                modeToggleBtn.classList.add('mode-button-inactive');
                toolSizeLabel.textContent = 'Tool Size:';
                canvas.style.cursor = 'crosshair';
            }
        }

        function showMessage(msg) {
            document.getElementById('messageText').textContent = msg;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        window.addEventListener('load', () => {
            const canvas = document.getElementById('doodleCanvas');
            const patternDisplayArea = document.getElementById('patternDisplayArea');
            const charDisplayArea = document.getElementById('charDisplayArea');

            resizeCanvas();
            
            // --- Initialize Sliders ---
            createCustomSlider({
                trackId: 'toolSizeSliderTrack', boxId: 'toolSizeSliderBox', dotId: 'toolSizeSliderDot', valueDisplayId: 'toolSizeValue',
                min: 1, max: 25, initialValue: currentToolSize,
                onUpdate: (newValue) => { currentToolSize = newValue; },
                isDotDynamic: true
            });

            createCustomSlider({
                trackId: 'dotSpacingSliderTrack', boxId: 'dotSpacingSliderBox', dotId: 'dotSpacingSliderDot', valueDisplayId: 'dotSpacingValue',
                min: 1, max: 100, initialValue: currentDotSpacing,
                onUpdate: (newValue) => { currentDotSpacing = newValue; },
                isDotDynamic: false
            });

            // --- Initialize Data and Previews ---
            fontCharacters = parseFontData(rawFontData);
            displayCurrentPatternPreview();
            displayCurrentCharPreview();
            updateModeButtonAppearance();
            canvas.style.cursor = 'crosshair';
            
            // --- Attach Event Listeners ---
            document.getElementById('prevPatternBtn').addEventListener('click', () => { if (currentPatternIndex > 0) { currentPatternIndex--; displayCurrentPatternPreview(); } });
            document.getElementById('nextPatternBtn').addEventListener('click', () => { if (currentPatternIndex < patterns.length - 1) { currentPatternIndex++; displayCurrentPatternPreview(); } });
            patternDisplayArea.addEventListener('click', () => { if (patterns.length > 0) { const p = patterns[currentPatternIndex]; placeMatrixInCenter(p.matrix, p.name, p.id); } });
            
            document.getElementById('prevCharBtn').addEventListener('click', () => { if (currentCharacterIndex > 0) { currentCharacterIndex--; displayCurrentCharPreview(); } });
            document.getElementById('nextCharBtn').addEventListener('click', () => { if (currentCharacterIndex < fontCharacters.length - 1) { currentCharacterIndex++; displayCurrentCharPreview(); } });
            charDisplayArea.addEventListener('click', () => { if (fontCharacters.length > 0) { const c = fontCharacters[currentCharacterIndex]; placeMatrixInCenter(c.matrix, c.name, c.id); } });

            document.getElementById('modeToggleBtn').addEventListener('click', () => { isErasing = !isErasing; updateModeButtonAppearance(); });
            document.getElementById('clearScreenBtn').addEventListener('click', () => { drawnDots = []; dotIdCounter = 0; redrawCanvas(); showMessage("Doodle area cleared!"); });
            document.getElementById('exportCsvBtn').addEventListener('click', () => {
                if (drawnDots.filter(dot => dot.isVisible).length === 0) { showMessage("No pattern to export!"); return; }
                let csvContent = "data:text/csv;charset=utf-8,X,Y,Size\r\n";
                drawnDots.forEach(dot => { if (dot.isVisible) { csvContent += `${dot.x.toFixed(2)},${dot.y.toFixed(2)},${dot.size}\r\n`; } });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "forge_pattern.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("Pattern exported to forge_pattern.csv");
            });
            document.getElementById('closeMessageBtn').addEventListener('click', () => { document.getElementById('messageBox').classList.add('hidden'); });

            canvas.addEventListener('mousedown', startDrawingAction);
            canvas.addEventListener('mousemove', performDrawingAction);
            canvas.addEventListener('mouseup', stopDrawingAction);
            canvas.addEventListener('mouseout', stopDrawingAction);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawingAction(e); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); performDrawingAction(e); });
            canvas.addEventListener('touchend', stopDrawingAction);
            canvas.addEventListener('touchcancel', stopDrawingAction);
        });

        window.addEventListener('resize', resizeCanvas);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered'), err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>
</html>